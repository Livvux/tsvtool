# =============================================================================
# Production Deployment - TSVTool
# =============================================================================
# Deploys to production on merge to master/main.
# Includes Convex deployment and comprehensive health checks.
# =============================================================================

name: ðŸŒ Production

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: production
  cancel-in-progress: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: ðŸ›« Pre-flight Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”· Type Check
        run: pnpm type-check

      - name: ðŸ§¹ Lint
        run: pnpm lint

      - name: ðŸ§ª Test
        run: pnpm test -- --run

  # ===========================================================================
  # Deploy Convex
  # ===========================================================================
  deploy-convex:
    name: ðŸ”¶ Deploy Convex
    runs-on: ubuntu-latest
    needs: preflight
    if: always() && (needs.preflight.result == 'success' || github.event.inputs.skip_tests == 'true')
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”¶ Deploy Convex Functions
        run: npx convex deploy --cmd 'echo "Skipping build - handled by Vercel"'
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: âœ… Convex Deployed
        run: |
          echo "### ðŸ”¶ Convex Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Functions and schema deployed successfully." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Deploy to Vercel Production
  # ===========================================================================
  deploy-production:
    name: ðŸŒ Deploy Production
    runs-on: ubuntu-latest
    needs: deploy-convex
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ“¥ Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: ðŸ”— Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy to Vercel Production
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "### ðŸŒ Production Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $url" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-deployment Health Check
  # ===========================================================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: â³ Wait for deployment
        run: sleep 30

      - name: ðŸ¥ Check health endpoint
        run: |
          url="${{ needs.deploy-production.outputs.url }}"
          echo "Checking health at: $url"
          
          # Try up to 5 times with 10s intervals
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            echo "Attempt $i: HTTP $response"
            
            if [ "$response" = "200" ] || [ "$response" = "307" ] || [ "$response" = "308" ]; then
              echo "âœ… Site is healthy!"
              exit 0
            fi
            
            sleep 10
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: ðŸ“ Health Check Summary
        if: always()
        run: |
          echo "### ðŸ¥ Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Production is healthy and responding" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health check failed - please investigate" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Create Release Tag
  # ===========================================================================
  create-release:
    name: ðŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check]
    if: success()
    permissions:
      contents: write
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Create Release Tag
        run: |
          # Generate version based on date and short SHA
          VERSION="v$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          
          echo "Creating release: $VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$VERSION" -m "Production release $VERSION"
          git push origin "$VERSION"
          
          echo "### ðŸ·ï¸ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Notify on Failure
  # ===========================================================================
  notify-failure:
    name: ðŸš¨ Notify Failure
    runs-on: ubuntu-latest
    needs: [deploy-convex, deploy-production, health-check]
    if: failure()
    steps:
      - name: ðŸš¨ Create failure summary
        run: |
          echo "### ðŸš¨ Production Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY

      # Optional: Add Slack/Discord notification here
      # - name: ðŸ“¢ Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "ðŸš¨ TSVTool production deployment failed!"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

